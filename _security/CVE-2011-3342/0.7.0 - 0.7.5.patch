---
layout: security_patch
cve: CVE-2011-3342
first_version: 0.7.0
last_version: 0.7.5
---

Index: src/saveload/saveload.cpp
===================================================================
--- src/saveload/saveload.cpp	(revision 22703)
+++ src/saveload/saveload.cpp	(working copy)
@@ -98,6 +98,11 @@
 	throw std::exception();
 }
 
+void SlErrorCorrupt(const char *message)
+{
+	SlError(STR_GAME_SAVELOAD_ERROR_BROKEN_SAVEGAME, message);
+}
+
 typedef void (*AsyncSaveFinishProc)();
 static AsyncSaveFinishProc _async_save_finish = NULL;
 static ThreadObject *_save_thread;
Index: src/saveload/saveload.h
===================================================================
--- src/saveload/saveload.h	(revision 22703)
+++ src/saveload/saveload.h	(working copy)
@@ -43,6 +43,7 @@
 SaveOrLoadResult SaveOrLoad(const char *filename, int mode, Subdirectory sb);
 void WaitTillSaved();
 void DoExitSave();
+NORETURN void SlErrorCorrupt(const char *message);
 
 
 typedef void ChunkSaveLoadProc();
Index: src/saveload/company_sl.cpp
===================================================================
--- src/saveload/company_sl.cpp	(revision 22703)
+++ src/saveload/company_sl.cpp	(working copy)
@@ -233,6 +233,7 @@
 	SlObject(&c->cur_economy, _company_economy_desc);
 
 	/* Write old economy entries. */
+	if (c->num_valid_stat_ent > lengthof(c->old_economy)) SlErrorCorrupt("Too many old economy entries");
 	for (i = 0; i < c->num_valid_stat_ent; i++) {
 		SlObject(&c->old_economy[i], _company_economy_desc);
 	}
Index: src/saveload/cheat_sl.cpp
===================================================================
--- src/saveload/cheat_sl.cpp	(revision 22703)
+++ src/saveload/cheat_sl.cpp	(working copy)
@@ -25,6 +25,8 @@
 {
 	Cheat *cht = (Cheat*)&_cheats;
 	size_t count = SlGetFieldLength() / 2;
+	/* Cannot use lengthof because _cheats is of type Cheats, not Cheat */
+	if (count > sizeof(_cheats) / sizeof(Cheat)) SlErrorCorrupt("Too many cheat values");
 
 	for (uint i = 0; i < count; i++) {
 		cht[i].been_used = (SlReadByte() != 0);
Index: src/saveload/ai_sl.cpp
===================================================================
--- src/saveload/ai_sl.cpp	(revision 22703)
+++ src/saveload/ai_sl.cpp	(working copy)
@@ -55,6 +55,8 @@
 
 	CompanyID index;
 	while ((index = (CompanyID)SlIterateArray()) != (CompanyID)-1) {
+		if (index >= MAX_COMPANIES) SlErrorCorrupt("Too many AI configs");
+
 		_ai_saveload_version = -1;
 		SlObject(NULL, _ai_company);
 
Index: src/saveload/strings_sl.cpp
===================================================================
--- src/saveload/strings_sl.cpp	(revision 22703)
+++ src/saveload/strings_sl.cpp	(working copy)
@@ -114,7 +114,12 @@
 	int index;
 
 	while ((index = SlIterateArray()) != -1) {
+		if (index >= 512) SlErrorCorrupt("Invalid old name index");
+		if (SlGetFieldLength() > 32) SlErrorCorrupt("Invalid old name length");
+
 		SlArray(&_old_name_array[32 * index], SlGetFieldLength(), SLE_UINT8);
+		/* Make sure the old name is null terminated */
+		_old_name_array[32 * index + 31] = '\0';
 	}
 }
 
